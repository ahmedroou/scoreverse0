
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // --- Default Deny ---
    match /{document=**} {
      allow read, write: if false;
    }

    // --- Public Shares (for embedding/sharing links) ---
    match /public_shares/{shareId} {
      allow get: if true;
    }

    // --- User Documents (/users/{userId}) ---
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow update: if isOwner(userId) && !(request.resource.data.isAdmin == true && resource.data.isAdmin == false);
      allow delete: if isAdmin() && request.auth.uid != userId;
    }

    // --- Shared Access Control ---
    match /shared_access/{docId} {
      allow write: if request.auth != null && request.auth.uid == docId.split('_')[1];
    }
    
    // --- General rules for a user's OWN subcollections ---
    match /users/{userId}/{collection}/{docId} {
       // Owner has full access to their own stuff
       allow read, write: if isOwner(userId);

       // A member of a space can READ items from the owner's collections
       allow read: if request.auth != null 
                   && exists(/databases/$(database)/documents/shared_access/$(request.auth.uid)_$(userId));
    }

    // --- Specific rule for 'spaces' links ---
    match /users/{inviteeId}/spaces/{spaceId} {
      // Allow OWNER of original space to CREATE a link doc for an invitee
      allow create: if request.auth.uid != inviteeId 
                    && request.resource.data.isShared == true
                    && get(/databases/$(database)/documents/users/$(request.resource.data.ownerId)/spaces/$(spaceId)).data.ownerId == request.auth.uid;
      
      // Allow OWNER of original space to DELETE a link doc from an invitee
      allow delete: if request.auth.uid != inviteeId
                    && resource.data.isShared == true
                    && request.auth.uid == resource.data.ownerId;
    }
  }
}
